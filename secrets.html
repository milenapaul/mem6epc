<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secrets Page</title>
    <style>
      body {
        margin: 0;
        font-family: Helvetica, Arial, sans-serif;
        color: white;
        text-align: center;
        padding: 0; /* Removed extra padding */
        box-sizing: border-box;
        height: 100%; /* Make body take full height */
        display: flex;
        flex-direction: column;
        justify-content: flex-start; /* Align content at the top */
      }

      h1 {
        margin-top: 20px; /* Keep space between the header and the secrets */
      }

      .secret-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        align-items: center;
        width: 100%;
        flex-grow: 1; /* Allows the container to expand and contract dynamically */
      }

      .secret {
        font-size: 5vw;
        text-transform: uppercase;
        text-align: center;
        color: white;
        cursor: pointer;
        white-space: nowrap;
        display: inline-block;
        transition: transform 0.2s, color 0.3s;
      }

      .secret .blurred {
        filter: blur(9px);
        color: white;
        cursor: not-allowed;
      }

      .lightbox {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        font-size: 1.5rem;
        justify-content: center;
        align-items: center;
      }

      .lightbox.visible {
        display: flex;
      }

      .close-lightbox {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        color: white;
        font-size: 2rem;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>Secrets</h1>
    <div class="secret-container" id="secretContainer">Loading...</div>
    <div class="lightbox" id="lightbox">
      <button class="close-lightbox" id="closeLightbox">Ã—</button>
      <div id="lightboxContent"></div>
    </div>

    <script>
      const API_KEY = "AIzaSyC-J-KrCY-wsS-qrjaEmn-SlVGkIZgBXD0"; // Replace with your API key
      const SPREADSHEET_ID = "1cXSunS1QhRCQ_S6yaRfU8tpCJt2H-U0j7iG4fB5VGK0"; // Replace with your sheet ID
      const RANGE = "Sheet1!A:B"; // Adjust as needed

      const secretContainer = document.getElementById("secretContainer");
      const params = new URLSearchParams(window.location.search);
      const currentLevel = params.get("level");

      const levelWordLimits = {
        free: 2,
        bronze: 3,
        silver: 6,
        gold: 10,
        platinum: 15,
        platinumplus: 25,
        diamond: 35,
        diamondplus: Infinity,
      };

      const maxWords = levelWordLimits[currentLevel] || 0;

      function adjustScaleX(secretDiv) {
        const viewportWidth = window.innerWidth;
        const padding = 40; // Total padding (20px on each side)
        const availableWidth = viewportWidth - padding;
        const secretWidth = secretDiv.scrollWidth;
        const scaleX = availableWidth / secretWidth;
        secretDiv.style.transform = `scaleX(${scaleX})`;
      }

      function fetchSecrets() {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            if (data.values && data.values.length > 0) {
              secretContainer.innerHTML = ""; // Clear loading
              // Filter out any rows that are empty
              const validSecrets = data.values.filter(([secret]) => secret && secret.trim() !== "");

              validSecrets.forEach(([secret]) => {
                const secretDiv = document.createElement("div");
                const words = secret.split(" ");
                const visibleWords = words.slice(0, maxWords).join(" ");
                const hiddenWords = words.slice(maxWords).join(" ");
                secretDiv.classList.add("secret");

                // Add text with visible and blurred parts (no "..." here)
                secretDiv.innerHTML = `${visibleWords} <span class="blurred">${hiddenWords}</span>`;

                secretDiv.onclick = () => showLightbox(secret, visibleWords, hiddenWords);
                secretContainer.appendChild(secretDiv);
                adjustScaleX(secretDiv);
              });
            } else {
              secretContainer.innerHTML = "<p>No secrets available.</p>";
            }
          })
          .catch((err) => console.error(err));
      }

      function showLightbox(secret, visibleWords, hiddenWords) {
        const lightbox = document.getElementById("lightbox");
        const lightboxContent = document.getElementById("lightboxContent");

        // Add the visible words to the lightbox content
        let content = visibleWords;

        // If there are hidden words, append "..." to indicate there are more words
        if (hiddenWords) {
          content += " ..."; // Add "..." to indicate there are hidden words
        }

        lightboxContent.textContent = content;
        lightbox.classList.add("visible");
      }

      window.addEventListener("resize", () => {
        const secrets = document.querySelectorAll(".secret");
        secrets.forEach((secretDiv) => adjustScaleX(secretDiv));
      });

      document.addEventListener("DOMContentLoaded", () => {
        fetchSecrets();  // Initial fetch
        document.getElementById("closeLightbox").onclick = () => {
          document.getElementById("lightbox").classList.remove("visible");
        };

        // Polling to fetch secrets every 60 seconds
        setInterval(fetchSecrets, 60000);  // Refresh every 60000ms (60 seconds)
      });
    </script>
    <script>
        const colors = ["#ff00dc", "#0000FF", "#ed0057", "#9d03fc"];
        document.body.style.backgroundColor =
          colors[Math.floor(Math.random() * colors.length)];
    
        const lastUpdated = document.createElement("p");
        lastUpdated.id = "lastUpdated";
        lastUpdated.style.marginTop = "20px";
        lastUpdated.style.fontSize = "1rem";
        lastUpdated.innerText = "Last Updated: " + new Date().toLocaleString();
        document.body.appendChild(lastUpdated);
      </script>
  </body>
</html>
